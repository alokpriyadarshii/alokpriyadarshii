name: Update README Stats Images

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # daily

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: update-readme-stats
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download stats SVGs
        shell: bash
        env:
          GH_USERNAME: alokpriyadarshii
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p assets

          is_valid_svg() {
            local file="$1"
            [[ -s "$file" ]] && grep -qi "<svg" "$file"
          }

          write_fallback_svg() {
            local output_file="$1"
            local message="$2"
            printf '%s\n' \
              '<svg xmlns="http://www.w3.org/2000/svg" width="495" height="195" viewBox="0 0 495 195" role="img" aria-label="Stats unavailable">' \
              '  <rect width="495" height="195" fill="#0d1117" />' \
              "  <text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"#c9d1d9\" font-family=\"Segoe UI, Arial, sans-serif\" font-size=\"20\">${message}</text>" \
              '</svg>' > "$output_file"
            echo "Wrote fallback SVG: $output_file"
          }

          download_svg() {
            local output_file="$1"
            shift

            local temp_file
            temp_file="$(mktemp)"

            local url
            for url in "$@"; do
              if curl -A "Mozilla/5.0" -fsSL --connect-timeout 10 --max-time 30 --retry 5 --retry-delay 2 "$url" -o "$temp_file"; then
                if is_valid_svg "$temp_file"; then
                  mv "$temp_file" "$output_file"
                  rm -f "$temp_file"
                  echo "Updated $output_file"
                  return 0
                fi
              fi
            done

            rm -f "$temp_file"

            if is_valid_svg "$output_file"; then
              echo "Could not refresh $output_file; keeping existing valid file."
              return 0
            fi

            write_fallback_svg "$output_file" "Stats temporarily unavailable"
          }

          download_svg assets/github-stats.svg \
            "https://github-readme-stats.vercel.app/api?username=alokpriyadarshii&show_icons=true&theme=highcontrast&hide_border=true&cache_seconds=21600" \
            "https://github-readme-stats-git-masterrstaa-rickstaa.vercel.app/api?username=alokpriyadarshii&show_icons=true&theme=highcontrast&hide_border=true&cache_seconds=21600"

          download_svg assets/github-streak.svg \
            "https://streak-stats.demolab.com?user=alokpriyadarshii&theme=highcontrast&hide_border=true" \
            "https://github-readme-streak-stats.herokuapp.com/?user=alokpriyadarshii&theme=highcontrast&hide_border=true"

          if python .github/scripts/generate_top_langs_svg.py "$GH_USERNAME" assets/top-langs.svg && is_valid_svg assets/top-langs.svg; then
            echo "Updated assets/top-langs.svg"
          elif is_valid_svg assets/top-langs.svg; then
            echo "Could not refresh assets/top-langs.svg; keeping existing valid file."
          else
            write_fallback_svg assets/top-langs.svg "Most used languages unavailable"
          fi

      - name: Skip PR creation without bot token
        if: ${{ secrets.STATS_BOT_TOKEN == '' }}
        run: |
          echo "STATS_BOT_TOKEN is not set; skipping PR creation."

      - name: Create pull request if changed
        if: ${{ secrets.STATS_BOT_TOKEN != '' && hashFiles('assets/*.svg') != '' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.STATS_BOT_TOKEN }}
          commit-message: "chore: update stats svgs"
          title: "chore: update stats svgs"
          body: "Automated update of README stats SVGs."
          branch: "automation/update-readme-stats"
          add-paths: |
            assets/*.svg
