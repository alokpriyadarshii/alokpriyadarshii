name: Update README Stats Images

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # daily

permissions:
  contents: write

concurrency:
  group: update-readme-stats
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download stats SVGs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p assets

          is_valid_svg() {
            local file="$1"
            [[ -s "$file" ]] && grep -qi "<svg" "$file"
          }

          download_svg() {
            local output_file="$1"
            shift

            local temp_file
            temp_file="$(mktemp)"

            local url
            for url in "$@"; do
              echo "Trying: $url"
              if curl -A "Mozilla/5.0" -fsSL --connect-timeout 10 --max-time 30 --retry 5 --retry-delay 2 "$url" -o "$temp_file"; then
                if is_valid_svg "$temp_file"; then
                  mv "$temp_file" "$output_file"
                  echo "Updated $output_file"
                  rm -f "$temp_file"
                  return 0
                fi
                echo "Response was not a valid SVG: $url"
              else
                echo "Failed to fetch: $url"
              fi
            done

            rm -f "$temp_file"

            if is_valid_svg "$output_file"; then
              echo "Could not refresh $output_file; keeping existing valid file."
              return 0
            fi

            printf '%s\n' \
              '<svg xmlns="http://www.w3.org/2000/svg" width="495" height="195" viewBox="0 0 495 195" role="img" aria-label="Stats unavailable">' \
              '  <rect width="495" height="195" fill="#0d1117" />' \
              '  <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#c9d1d9" font-family="Segoe UI, Arial, sans-serif" font-size="20">Stats temporarily unavailable</text>' \
              '</svg>' > "$output_file"
            echo "Wrote fallback SVG: $output_file"
          }

          download_svg assets/github-stats.svg \
            "https://github-readme-stats.vercel.app/api?username=alokpriyadarshii&show_icons=true&theme=highcontrast&hide_border=true" \
            "https://github-readme-stats-git-masterrstaa-rickstaa.vercel.app/api?username=alokpriyadarshii&show_icons=true&theme=highcontrast&hide_border=true"

          download_svg assets/github-streak.svg \
            "https://streak-stats.demolab.com?user=alokpriyadarshii&theme=highcontrast&hide_border=true" \
            "https://github-readme-streak-stats.herokuapp.com/?user=alokpriyadarshii&theme=highcontrast&hide_border=true"

          download_svg assets/top-langs.svg \
            "https://github-readme-stats.vercel.app/api/top-langs/?username=alokpriyadarshii&layout=compact&langs_count=8&custom_title=Most%20Used%20Languages&theme=highcontrast&hide_border=false&border_color=ffffff" \
            "https://github-readme-stats-git-masterrstaa-rickstaa.vercel.app/api/top-langs/?username=alokpriyadarshii&layout=compact&langs_count=8&custom_title=Most%20Used%20Languages&theme=highcontrast&hide_border=false&border_color=ffffff"

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "$(git status --porcelain -- assets)" ]]; then
            echo "No asset changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/*.svg
          git commit -m "chore: update stats svgs"
          git push
